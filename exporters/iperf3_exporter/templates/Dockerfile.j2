# --- stage 1: resolver (AlmaLinux has full AppStream)
FROM almalinux:9 AS resolver

# Multi-arch support: map Docker platform to RPM arch
ARG TARGETARCH
RUN case "$TARGETARCH" in \
      amd64) RPM_ARCH=x86_64 ;; \
      arm64) RPM_ARCH=aarch64 ;; \
      *) echo "Unsupported architecture: $TARGETARCH"; exit 1 ;; \
    esac && \
    dnf -y install dnf-plugins-core && \
    mkdir -p /rpms && \
    dnf download --resolve --arch "$RPM_ARCH" --destdir=/rpms iperf3

# --- stage 2: runtime (UBI minimal)
FROM {{ artifacts.docker.base_image }}

# Install basic dependencies available in UBI
RUN microdnf install -y ca-certificates lksctp-tools && \
    microdnf clean all

# Install RPMs downloaded from Alma
COPY --from=resolver /rpms /rpms
RUN rpm -Uvh --force --nodeps /rpms/*.rpm && \
    rm -rf /rpms

# Create necessary directories
RUN mkdir -p /etc/{{ name }} /var/lib/{{ name }}

# Copy main binary
COPY {{ build.binary_name }} /usr/bin/{{ name }}

WORKDIR /var/lib/{{ name }}

ENTRYPOINT {{ artifacts.docker.entrypoint | tojson }}
