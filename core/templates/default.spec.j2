# Template RPM par d√©faut (Production Grade)
%define debug_package %{nil}

Name:           {{ name }}
Version:        {{ version }}
Release:        1%{?dist}
Summary:        {{ artifacts.rpm.summary | default(description) }}

License:        Apache-2.0
URL:            https://github.com/{{ upstream.repo }}
# Sources are provided pre-extracted by the build engine
Source0:        {{ build.binary_name }}
{% for file in artifacts.rpm.extra_files %}
Source{{ loop.index }}: {{ file.build_source }}
{% endfor %}

BuildArch:      {{ rpm_arch }}

{% if artifacts.rpm.systemd.enabled %}
BuildRequires:  systemd-rpm-macros
{% endif %}

{% for dep in artifacts.rpm.dependencies %}
Requires:       {{ dep }}
{% endfor %}

{% if artifacts.rpm.system_user %}
Requires(pre):  shadow-utils
{% endif %}

{% if artifacts.rpm.systemd.enabled %}
%{?systemd_requires}
{% endif %}

%description
{{ description }}

%prep
%setup -q -c -T
# Files are already present in the SOURCES directory

%build
# Nothing to build, binary repack

{% set binary_dir = artifacts.rpm.install_path | default('%{_bindir}', true) %}

%install
rm -rf $RPM_BUILD_ROOT
install -D -m 0755 %{SOURCE0} $RPM_BUILD_ROOT{{ binary_dir }}/{{ name }}

{% if artifacts.rpm.systemd.enabled %}
# Install systemd service
mkdir -p $RPM_BUILD_ROOT%{_unitdir}
cat <<EOF > $RPM_BUILD_ROOT%{_unitdir}/{{ name }}.service
[Unit]
Description={{ description }}
After={{ artifacts.rpm.systemd.after | join(' ') }}

[Service]
Type={{ artifacts.rpm.systemd.type }}
{% if artifacts.rpm.system_user %}
User={{ artifacts.rpm.system_user }}
{% endif %}
ExecStart={{ binary_dir }}/{{ name }} {{ artifacts.rpm.systemd.arguments | join(' ') }}
Restart={{ artifacts.rpm.systemd.restart }}

[Install]
WantedBy=multi-user.target
EOF
{% endif %}

# Create directories
{% for dir in artifacts.rpm.directories %}
mkdir -p $RPM_BUILD_ROOT{{ dir.path }}
{% endfor %}

# Install extra files
{% for file in artifacts.rpm.extra_files %}
install -D -m {{ file.mode }} %{SOURCE{{ loop.index }}} $RPM_BUILD_ROOT{{ file.dest }}
{% endfor %}

{% if artifacts.rpm.system_user %}
%pre
getent group {{ artifacts.rpm.system_user }} >/dev/null || groupadd -r {{ artifacts.rpm.system_user }}
getent passwd {{ artifacts.rpm.system_user }} >/dev/null || \
    useradd -r -g {{ artifacts.rpm.system_user }} -d /var/lib/{{ name }} -s /sbin/nologin \
    -c "User for {{ name }}" {{ artifacts.rpm.system_user }}
exit 0
{% endif %}

{% if artifacts.rpm.systemd.enabled %}
%post
%systemd_post {{ name }}.service

%preun
%systemd_preun {{ name }}.service

%postun
%systemd_postun_with_restart {{ name }}.service
{% endif %}

%files
{{ binary_dir }}/{{ name }}
{% if artifacts.rpm.systemd.enabled %}
%{_unitdir}/{{ name }}.service
{% endif %}

{% for dir in artifacts.rpm.directories %}
%dir %attr({{ dir.mode }}, {{ dir.owner }}, {{ dir.group }}) {{ dir.path }}
{% endfor %}

{% for file in artifacts.rpm.extra_files %}
{% if file.config %}
%config(noreplace) {{ file.dest }}
{% else %}
{{ file.dest }}
{% endif %}
{% endfor %}

%changelog
* Wed Jan 07 2026 Monitoring Hub <bot@monitoring-hub.local> - {{ version }}-1
- Standardized build with modern systemd integration
