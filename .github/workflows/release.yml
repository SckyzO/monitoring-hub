name: Release and Publish

on:
  push:
    branches: [ main ]
    paths:
      - 'exporters/**'
      - 'core/**'
      - '.github/workflows/**'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # 1. Discover all exporters dynamically
  discover:
    runs-on: ubuntu-latest
    outputs:
      exporters: ${{ steps.set-matrix.outputs.exporters }}
    steps:
      - uses: actions/checkout@v4
      - id: set-matrix
        run: |
          # Find directories in exporters/ containing manifest.yaml
          # Output simple JSON array of names: ["node_exporter", "prometheus", ...]
          python3 -c "import os, json; print('exporters=' + json.dumps([d for d in os.listdir('exporters') if os.path.isdir(os.path.join('exporters', d)) and os.path.exists(os.path.join('exporters', d, 'manifest.yaml'))]))" >> $GITHUB_OUTPUT

  # 2. Build Docker Images (Parallel per exporter)
  build-docker:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        exporter: ${{ fromJson(needs.discover.outputs.exporters) }}
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - run: pip install -r core/requirements.txt

      - name: Log in to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push
        run: |
          exporter="${{ matrix.exporter }}"
          echo "Processing $exporter..."
          
          # Generate build files (default arch, dockerfile is generic)
          python core/builder.py --manifest "exporters/$exporter/manifest.yaml" --output-dir "build/$exporter" --arch amd64
          
          version=$(grep "version:" "exporters/$exporter/manifest.yaml" | awk '{print $2}' | tr -d '"')
          
          if [ -f "build/$exporter/Dockerfile" ]; then
             image_id="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/$exporter"
             image_id=$(echo $image_id | tr '[:upper:]' '[:lower:]')
            
             # Currently building amd64 only for Docker as per previous config
             docker buildx build \
              --file "build/$exporter/Dockerfile" \
              --push \
              --label "org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}" \
              --tag "$image_id:$version" \
              --tag "$image_id:latest" \
              --platform linux/amd64 \
              "build/$exporter"
          fi

  # 3. Build RPMs (Parallel per exporter AND architecture)
  build-rpm:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        exporter: ${{ fromJson(needs.discover.outputs.exporters) }}
        arch: [amd64, arm64]
    steps:
      - uses: actions/checkout@v4
      
      # QEMU needed for arm64
      - name: Set up QEMU
        if: matrix.arch == 'arm64'
        uses: docker/setup-qemu-action@v3

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - run: pip install -r core/requirements.txt

      - name: Build RPM
        run: |
          exporter="${{ matrix.exporter }}"
          arch="${{ matrix.arch }}"
          echo "Building RPM for $exporter ($arch)..."
          
          build_dir="build/$exporter-$arch"
          
          # Generate Spec and Download binary
          python core/builder.py --manifest "exporters/$exporter/manifest.yaml" --output-dir "$build_dir" --arch "$arch"
          
          spec_file="$build_dir/$exporter.spec"
          if [ -f "$spec_file" ]; then
            chmod +x core/build_rpm.sh core/utils/rpm_build_entrypoint.sh
            ./core/build_rpm.sh "$spec_file" "$build_dir/rpms" "$arch"
          else
            echo "No spec file generated (RPM disabled for this exporter?), skipping."
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          # Unique name per artifact
          name: rpm-${{ matrix.exporter }}-${{ matrix.arch }}
          path: build/**/rpms/**/*.rpm
          if-no-files-found: ignore

  # 4. Publish YUM Repo & Website (Fan-in)
  publish-yum:
    needs: build-rpm
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all_rpms
          pattern: rpm-*
          merge-multiple: true

      - name: Set up Python (for site gen)
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - run: pip install -r core/requirements.txt

      - name: Update Repository and Site
        run: |
          # Checkout gh-pages
          git fetch origin gh-pages
          git worktree add -B gh-pages gh-pages-dist origin/gh-pages
          
          cd gh-pages-dist
          
          # Prepare structure
          mkdir -p el9/x86_64 el9/aarch64
          
          # Copy downloaded RPMs to correct folders
          # Artifacts are flat in all_rpms/ because of merge-multiple
          echo "Moving RPMs..."
          find ../all_rpms -name "*.x86_64.rpm" -exec cp {} el9/x86_64/ \;
          find ../all_rpms -name "*.aarch64.rpm" -exec cp {} el9/aarch64/ \;
          
          # Update metadata (needs docker but no QEMU needed here as createrepo is arch-agnostic usually, 
          # but we run it inside almalinux container which is x86_64)
          # We also fix permissions because docker runs as root and we need to write index.html later
          docker run --rm -v $(pwd):/repo almalinux:9 /bin/bash -c "dnf install -y createrepo_c && \
             createrepo_c /repo/el9/x86_64 && \
             createrepo_c /repo/el9/aarch64 && \
             chown -R $(id -u):$(id -g) /repo"

          # Recursive Index Generation
          find . -type d -not -path '*/.*' | while read dir; do
            if [ ! -f "$dir/index.html" ]; then
              echo "Generating index for $dir"
              echo "<!DOCTYPE html><html><head><title>Index of $dir</title><meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"><style>body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif;padding:20px;line-height:1.5}h1{margin-bottom:20px;font-size:1.5em}a{text-decoration:none;color:#0366d6}a:hover{text-decoration:underline}ul{list-style-type:none;padding:0}li{padding:5px 0;border-bottom:1px solid #eee}</style></head><body>" > "$dir/index.html"
              echo "<h1>Index of $dir</h1>" >> "$dir/index.html"
              echo "<ul><li><a href=\"../\">üìÇ Parent Directory</a></li>" >> "$dir/index.html"
              
              # List files and directories
              for f in "$dir"/*; do
                fname=$(basename "$f")
                if [ "$fname" != "index.html" ]; then
                   if [ -d "$f" ]; then
                     echo "<li><a href=\"$fname/\">üìÅ $fname/</a></li>" >> "$dir/index.html"
                   else
                     size=$(du -h "$f" | cut -f1)
                     echo "<li><a href=\"$fname\">üìÑ $fname</a> <span style=\"color:#666;font-size:0.85em;float:right\">$size</span></li>" >> "$dir/index.html"
                   fi
                fi
              done
              echo "</ul></body></html>" >> "$dir/index.html"
            fi
          done

          # Generate Main Site
          cd ..
          python core/gen_site.py --output gh-pages-dist/index.html
          cd gh-pages-dist
          
          # Commit and Push
          git config user.name "Monitoring Hub Bot"
          git config user.email "bot@monitoring-hub.local"
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: update yum repository and landing page [skip ci]"
            git push origin gh-pages
          fi
