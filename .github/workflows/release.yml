name: ğŸš€ Release

on:
  workflow_dispatch:
    inputs:
      exporter:
        description: 'Exporter to build (for testing)'
        required: true
        default: 'node_exporter'
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

# Ensure only one release at a time
concurrency:
  group: release-v2
  cancel-in-progress: false

jobs:
  # 1. Build RPM and upload to GitHub Releases
  build-rpm:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for creating releases
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
        dist: [el8, el9, el10]
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
      - run: pip install -r requirements/base.txt

      - name: ğŸ”¨ Build RPM
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          exporter="${{ inputs.exporter }}"
          arch="${{ matrix.arch }}"
          dist="${{ matrix.dist }}"

          echo "::group::ğŸ”¨ Building RPM Package"
          echo "ğŸ“¦ Package: $exporter"
          echo "ğŸ—ï¸  Architecture: $arch"
          echo "ğŸ§ Distribution: $dist"
          echo "::endgroup::"

          case $dist in
            el8) image="almalinux:8" ;;
            el9) image="almalinux:9" ;;
            el10) image="quay.io/centos/centos:stream10" ;;
          esac

          build_dir="build/$exporter-$arch-$dist"

          echo "::group::ğŸ”§ Generating RPM spec file"
          python3 -m core.engine.builder --manifest "exporters/$exporter/manifest.yaml" --output-dir "$build_dir" --arch "$arch"
          echo "âœ“ Spec file generated"
          echo "::endgroup::"

          spec_file="$build_dir/$exporter.spec"
          if [ -f "$spec_file" ]; then
            echo "::group::ğŸ³ Building RPM in container ($image)"
            chmod +x core/scripts/build_rpm.sh core/scripts/rpm_entrypoint.sh
            ./core/scripts/build_rpm.sh "$spec_file" "$build_dir/rpms" "$arch" "$image"
            echo "âœ“ RPM build completed"
            echo "::endgroup::"
          fi

      - name: ğŸ” Sign RPM
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
        run: |
          exporter="${{ inputs.exporter }}"
          arch="${{ matrix.arch }}"
          dist="${{ matrix.dist }}"

          build_dir="build/$exporter-$arch-$dist"
          rpm_file=$(find "$build_dir/rpms" -name "*.rpm" | head -1)

          if [ -z "$rpm_file" ]; then
            echo "âš ï¸  No RPM file found, skipping signing"
            exit 0
          fi

          echo "::group::ğŸ” Signing RPM with GPG"
          echo "ğŸ“„ File: $(basename "$rpm_file")"
          chmod +x core/scripts/sign_rpm_container.sh
          ./core/scripts/sign_rpm_container.sh "$rpm_file" "$GPG_PRIVATE_KEY" "$GPG_PASSPHRASE" "$GPG_KEY_ID"
          echo "âœ“ RPM signed successfully"
          echo "::endgroup::"

      - name: ğŸ“‹ Get Version
        id: version
        run: |
          exporter="${{ inputs.exporter }}"
          version=$(python3 -c "import yaml; m=yaml.safe_load(open('exporters/$exporter/manifest.yaml')); print(m['version'].lstrip('v'))")
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Version: v$version"

      - name: â¬†ï¸  Upload to GitHub Releases
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          exporter="${{ inputs.exporter }}"
          arch="${{ matrix.arch }}"
          dist="${{ matrix.dist }}"
          version="${{ steps.version.outputs.version }}"
          build_dir="build/$exporter-$arch-$dist"

          rpm_files=$(find "$build_dir/rpms" -name "*.rpm")
          if [ -z "$rpm_files" ]; then
            echo "âš ï¸  No RPM files to upload"
            exit 0
          fi

          echo "::group::â¬†ï¸  Uploading to GitHub Releases"
          echo "ğŸ·ï¸  Release: v$version"
          echo "ğŸ“¦ Files:"
          for file in $rpm_files; do
            echo "  â†’ $(basename "$file")"
          done

          python3 core/scripts/upload_to_release.py \
            --repo ${{ github.repository }} \
            --exporter "$exporter" \
            --version "$version" \
            --files $rpm_files \
            --output "$build_dir/release_urls.json"

          echo "âœ“ Upload completed"
          echo "::endgroup::"

      - name: Upload Release URLs Artifact
        uses: actions/upload-artifact@v6
        with:
          name: release-urls-rpm-${{ inputs.exporter }}-${{ matrix.arch }}-${{ matrix.dist }}
          path: build/**/release_urls.json
          if-no-files-found: ignore
          retention-days: 7

  # 2. Build DEB and upload to GitHub Releases
  build-deb:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for creating releases
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
        dist: [ubuntu-22.04, ubuntu-24.04, debian-12, debian-13]
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
      - run: pip install -r requirements/base.txt

      - name: ğŸ”¨ Build DEB
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          exporter="${{ inputs.exporter }}"
          arch="${{ matrix.arch }}"
          dist="${{ matrix.dist }}"

          echo "::group::ğŸ”¨ Building DEB Package"
          echo "ğŸ“¦ Package: $exporter"
          echo "ğŸ—ï¸  Architecture: $arch"
          echo "ğŸ§ Distribution: $dist"
          echo "::endgroup::"

          case $dist in
            ubuntu-22.04) image="ubuntu:22.04" ;;
            ubuntu-24.04) image="ubuntu:24.04" ;;
            debian-12) image="debian:12" ;;
            debian-13) image="debian:trixie" ;;
          esac

          build_dir="build/$exporter-$dist-$arch"

          echo "::group::ğŸ”§ Generating DEB control files"
          python3 -m core.engine.builder --manifest "exporters/$exporter/manifest.yaml" --output-dir "$build_dir" --arch "$arch"
          echo "âœ“ Control files generated"
          echo "::endgroup::"

          echo "::group::ğŸ³ Building DEB in container ($image)"
          chmod +x core/scripts/build_deb.sh core/scripts/deb_entrypoint.sh
          ./core/scripts/build_deb.sh "$build_dir" "$build_dir/debs" "$arch" "$image"
          echo "âœ“ DEB build completed"
          echo "::endgroup::"

      - name: ğŸ” Sign DEB
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
        run: |
          exporter="${{ inputs.exporter }}"
          arch="${{ matrix.arch }}"
          dist="${{ matrix.dist }}"

          build_dir="build/$exporter-$dist-$arch"
          deb_file=$(find "$build_dir/debs" -name "*.deb" | head -1)

          if [ -z "$deb_file" ]; then
            echo "âš ï¸  No DEB file found, skipping signing"
            exit 0
          fi

          echo "::group::ğŸ” Signing DEB with GPG"
          echo "ğŸ“„ File: $(basename "$deb_file")"
          chmod +x core/scripts/sign_deb_container.sh
          ./core/scripts/sign_deb_container.sh "$deb_file" "$GPG_PRIVATE_KEY" "$GPG_PASSPHRASE" "$GPG_KEY_ID" "$dist"
          echo "âœ“ DEB signed successfully"
          echo "::endgroup::"

      - name: ğŸ“‹ Get Version
        id: version
        run: |
          exporter="${{ inputs.exporter }}"
          version=$(python3 -c "import yaml; m=yaml.safe_load(open('exporters/$exporter/manifest.yaml')); print(m['version'].lstrip('v'))")
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Version: v$version"

      - name: â¬†ï¸  Upload to GitHub Releases
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          exporter="${{ inputs.exporter }}"
          arch="${{ matrix.arch }}"
          dist="${{ matrix.dist }}"
          version="${{ steps.version.outputs.version }}"
          build_dir="build/$exporter-$dist-$arch"

          deb_files=$(find "$build_dir/debs" -name "*.deb")
          if [ -z "$deb_files" ]; then
            echo "âš ï¸  No DEB files to upload"
            exit 0
          fi

          echo "::group::â¬†ï¸  Uploading to GitHub Releases"
          echo "ğŸ·ï¸  Release: v$version"
          echo "ğŸ“¦ Files:"
          for file in $deb_files; do
            echo "  â†’ $(basename "$file")"
          done

          python3 core/scripts/upload_to_release.py \
            --repo ${{ github.repository }} \
            --exporter "$exporter" \
            --version "$version" \
            --files $deb_files \
            --output "$build_dir/release_urls.json"

          echo "âœ“ Upload completed"
          echo "::endgroup::"

      - name: Upload Release URLs Artifact
        uses: actions/upload-artifact@v6
        with:
          name: release-urls-deb-${{ inputs.exporter }}-${{ matrix.arch }}-${{ matrix.dist }}
          path: build/**/release_urls.json
          if-no-files-found: ignore
          retention-days: 7

  # 3. Generate YUM/APT Metadata and Portal (single commit to gh-pages)
  publish-metadata:
    needs: [build-rpm, build-deb]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
      - run: pip install -r requirements/base.txt

      - name: Download Release URLs (RPM + DEB)
        uses: actions/download-artifact@v6
        with:
          pattern: release-urls-*
          path: release-urls/
          merge-multiple: true

      - name: ğŸ“¥ Checkout gh-pages
        run: |
          echo "::group::ğŸ“¥ Setting up gh-pages worktree"
          git fetch origin gh-pages
          git worktree add -B gh-pages gh-pages-dist origin/gh-pages
          echo "âœ“ gh-pages ready"
          echo "::endgroup::"

      - name: ğŸ“¦ Generate YUM Metadata
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
        run: |
          echo "::group::ğŸ§¹ Cleaning previous signatures"
          rm -rf gh-pages-dist/*/*/repodata/*.asc
          echo "âœ“ Cleaned"
          echo "::endgroup::"

          for dist in el8 el9 el10; do
            for arch in x86_64 aarch64; do
              echo "::group::ğŸ“¦ Generating YUM metadata for $dist/$arch"

              python3 core/scripts/generate_yum_metadata.py \
                --release-urls-dir release-urls/ \
                --output-dir gh-pages-dist \
                --dist "$dist" \
                --arch "$arch"

              repomd_file="gh-pages-dist/$dist/$arch/repodata/repomd.xml"
              if [ -f "$repomd_file" ]; then
                echo "ğŸ” Signing repomd.xml..."
                echo "$GPG_PRIVATE_KEY" | base64 -d | gpg --batch --import 2>/dev/null
                gpg --batch --passphrase "$GPG_PASSPHRASE" \
                    --detach-sign --armor "$repomd_file"
                echo "âœ“ Metadata generated and signed for $dist/$arch"
              fi
              echo "::endgroup::"
            done
          done

          if [ -n "${{ secrets.GPG_PUBLIC_KEY }}" ]; then
            echo "ğŸ”‘ Publishing GPG public key..."
            echo "${{ secrets.GPG_PUBLIC_KEY }}" | base64 -d > gh-pages-dist/RPM-GPG-KEY-monitoring-hub
            echo "âœ“ GPG key published"
          fi

      - name: ğŸ“¦ Generate APT Metadata
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
        run: |
          echo "::group::ğŸ§¹ Cleaning previous signatures"
          rm -rf gh-pages-dist/apt/dists/*/InRelease gh-pages-dist/apt/dists/*/Release.gpg
          echo "âœ“ Cleaned"
          echo "::endgroup::"

          for dist in ubuntu-22.04 ubuntu-24.04 debian-12 debian-13; do
            for arch in amd64 arm64; do
              echo "::group::ğŸ“¦ Generating APT metadata for $dist/$arch"

              python3 core/scripts/generate_apt_metadata.py \
                --release-urls-dir release-urls/ \
                --output-dir gh-pages-dist/apt \
                --dist "$dist" \
                --arch "$arch"

              echo "âœ“ Metadata generated for $dist/$arch"
              echo "::endgroup::"
            done
          done

          echo "::group::ğŸ” Signing Release files"
          echo "$GPG_PRIVATE_KEY" | base64 -d | gpg --batch --import 2>/dev/null

          for release_file in gh-pages-dist/apt/dists/*/Release; do
            if [ -f "$release_file" ]; then
              codename=$(basename $(dirname "$release_file"))
              echo "  â†’ Signing $codename..."

              if [ -n "$GPG_PASSPHRASE" ]; then
                gpg --batch --passphrase "$GPG_PASSPHRASE" \
                    --clearsign --output "$(dirname "$release_file")/InRelease" "$release_file" 2>/dev/null
                gpg --batch --passphrase "$GPG_PASSPHRASE" \
                    --detach-sign --armor --output "$release_file.gpg" "$release_file" 2>/dev/null
              else
                gpg --batch --clearsign --output "$(dirname "$release_file")/InRelease" "$release_file" 2>/dev/null
                gpg --batch --detach-sign --armor --output "$release_file.gpg" "$release_file" 2>/dev/null
              fi
              echo "    âœ“ Signed"
            fi
          done
          echo "::endgroup::"

          if [ -n "${{ secrets.GPG_PUBLIC_KEY }}" ]; then
            echo "ğŸ”‘ Publishing GPG public key..."
            echo "${{ secrets.GPG_PUBLIC_KEY }}" | base64 -d > gh-pages-dist/apt/monitoring-hub.asc
            echo "âœ“ GPG key published"
          fi

      - name: ğŸŒ Generate Portal
        run: |
          echo "::group::ğŸŒ Generating web portal"

          python3 -m core.engine.site_generator \
            --output gh-pages-dist/index.html \
            --repo-dir gh-pages-dist

          echo "âœ“ Portal generated (index.html + catalog.json)"
          echo "::endgroup::"

      - name: ğŸš€ Deploy to gh-pages
        run: |
          echo "::group::ğŸš€ Deploying to GitHub Pages"
          cd gh-pages-dist
          git config user.name "Monitoring Hub Bot"
          git config user.email "bot@monitoring-hub.local"
          git add .

          if git diff --staged --quiet; then
            echo "â„¹ï¸  No changes to commit"
          else
            echo "ğŸ“ Committing changes..."
            git commit -m "chore: update repository metadata and portal"

            echo "â¬†ï¸  Pushing to gh-pages..."
            git push origin gh-pages

            echo "âœ“ Deployment completed"
          fi
          echo "::endgroup::"
