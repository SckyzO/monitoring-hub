name: Release and Publish

on:
  push:
    branches: [ main ]
    paths:
      - 'exporters/**'
      - 'core/**'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push-docker:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -r core/requirements.txt

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Docker Images
        run: |
          for exporter in exporters/*/; do
            if [ -f "${exporter}manifest.yaml" ]; then
              name=$(basename "$exporter")
              echo "Processing $name..."
              
              # Generate build files
              python core/builder.py --manifest "${exporter}manifest.yaml" --output-dir "build/$name"
              
              # Extract info from manifest for tagging (simple parsing for now)
              version=$(grep "version:" "${exporter}manifest.yaml" | awk '{print $2}' | tr -d '"')
              
              if [ -f "build/$name/Dockerfile" ]; then
                echo "Building Docker image for $name version $version"
                
                # Build and push
                # Tag: ghcr.io/owner/repo/exporter_name:version
                # Tag: ghcr.io/owner/repo/exporter_name:latest
                
                image_id="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/$name"
                image_id=$(echo $image_id | tr '[:upper:]' '[:lower:]')
                
                docker buildx build \
                  --file "build/$name/Dockerfile" \
                  --push \
                  --tag "$image_id:$version" \
                  --tag "$image_id:latest" \
                  "build/$name"
              fi
            fi
          done

  update-yum-repo:
    runs-on: ubuntu-latest
    needs: build-and-push-docker # Ensure docker builds are fine first (optional dependency)
    permissions:
      contents: write # Needed to push to gh-pages
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -r core/requirements.txt

      - name: Generate RPMs
        run: |
          for exporter in exporters/*/; do
            if [ -f "${exporter}manifest.yaml" ]; then
              name=$(basename "$exporter")
              echo "Processing $name for RPM..."
              
              # Ensure build files exist (might have been generated in previous job but separate runners usually mean separate fs)
              # Re-running builder is cheap
              python core/builder.py --manifest "${exporter}manifest.yaml" --output-dir "build/$name"
              
              spec_file="build/$name/$name.spec"
              if [ -f "$spec_file" ]; then
                echo "Building RPM from $spec_file..."
                chmod +x core/build_rpm.sh core/utils/rpm_build_entrypoint.sh
                ./core/build_rpm.sh "$spec_file" "build/$name/rpms"
              fi
            fi
          done

      - name: Update YUM Repository
        run: |
          # Checkout gh-pages
          git fetch origin gh-pages
          git worktree add -B gh-pages gh-pages-dist origin/gh-pages
          
          cd gh-pages-dist
          
          # Prepare directory structure (e.g. el9/x86_64)
          # Currently hardcoded for el9 as per our build script
          mkdir -p el9/x86_64
          
          # Copy new RPMs
          # We need to find where they are in the main worktree
          cp ../build/*/rpms/*/*.rpm el9/x86_64/ || echo "No new RPMs found"
          
          # Update metadata
          # We use a docker container for createrepo to avoid installing it on the runner
          docker run --rm -v $(pwd):/repo almalinux:9 /bin/bash -c "dnf install -y createrepo_c && createrepo_c /repo/el9/x86_64"
          
          # Commit and push
          git config user.name "Monitoring Hub Bot"
          git config user.email "bot@monitoring-hub.local"
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: update yum repository [skip ci]"
            git push origin gh-pages
          fi

