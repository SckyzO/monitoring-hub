name: Release and Publish

on:
  push:
    branches: [ main ]
    paths:
      - 'exporters/**'
      - 'core/**'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push-docker:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -r core/requirements.txt

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Docker Images
        run: |
          for exporter in exporters/*/; do
            if [ -f "${exporter}manifest.yaml" ]; then
              name=$(basename "$exporter")
              echo "Processing $name..."
              
              # Generate build files
              python core/builder.py --manifest "${exporter}manifest.yaml" --output-dir "build/$name"
              
              # Extract info from manifest for tagging (simple parsing for now)
              version=$(grep "version:" "${exporter}manifest.yaml" | awk '{print $2}' | tr -d '"')
              
                              if [ -f "build/$name/Dockerfile" ]; then
                              echo "Building Docker image for $name version $version"
                              echo "Build context directory: build/$name"
                              ls -la "build/$name"
                              
                              # Build and push                # Tag: ghcr.io/owner/repo/exporter_name:version
                # Tag: ghcr.io/owner/repo/exporter_name:latest
                
                image_id="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/$name"
                image_id=$(echo $image_id | tr '[:upper:]' '[:lower:]')
                
                docker buildx build \
                  --file "build/$name/Dockerfile" \
                  --push \
                  --label "org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}" \
                  --tag "$image_id:$version" \
                  --tag "$image_id:latest" \
                  "build/$name"
              fi
            fi
          done

  update-yum-repo:
    runs-on: ubuntu-latest
    needs: build-and-push-docker # Ensure docker builds are fine first (optional dependency)
    permissions:
      contents: write # Needed to push to gh-pages
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -r core/requirements.txt

      - name: Generate RPMs
        run: |
          for exporter in exporters/*/; do
            if [ -f "${exporter}manifest.yaml" ]; then
              name=$(basename "$exporter")
              echo "Processing $name for RPM..."
              
              # Ensure build files exist (might have been generated in previous job but separate runners usually mean separate fs)
              # Re-running builder is cheap
              python core/builder.py --manifest "${exporter}manifest.yaml" --output-dir "build/$name"
              
              spec_file="build/$name/$name.spec"
              if [ -f "$spec_file" ]; then
                echo "Building RPM from $spec_file..."
                chmod +x core/build_rpm.sh core/utils/rpm_build_entrypoint.sh
                ./core/build_rpm.sh "$spec_file" "build/$name/rpms"
              fi
            fi
          done

      - name: Update YUM Repository
        run: |
          # Checkout gh-pages
          git fetch origin gh-pages
          git worktree add -B gh-pages gh-pages-dist origin/gh-pages
          
          cd gh-pages-dist
          
          # Prepare directory structure (e.g. el9/x86_64)
          # Currently hardcoded for el9 as per our build script
          mkdir -p el9/x86_64
          
          # Copy new RPMs
          # We need to find where they are in the main worktree
          cp ../build/*/rpms/*/*.rpm el9/x86_64/ || echo "No new RPMs found"
          
          # Update metadata
          # We use a docker container for createrepo to avoid installing it on the runner
          docker run --rm -v $(pwd):/repo almalinux:9 /bin/bash -c "dnf install -y createrepo_c && createrepo_c /repo/el9/x86_64"

          # Generate Directory Listing (index.html) for Browsing
          # Simple bash script to mimic Apache/Nginx directory listing
          cd el9/x86_64
          echo "<!DOCTYPE html><html><head><title>Index of /el9/x86_64</title><meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"><style>body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif;padding:20px;line-height:1.5}h1{margin-bottom:20px}a{text-decoration:none;color:#0366d6}a:hover{text-decoration:underline}ul{list-style-type:none;padding:0}li{padding:5px 0;border-bottom:1px solid #eee}</style></head><body>" > index.html
          echo "<h1>Index of /el9/x86_64</h1>" >> index.html
          echo "<ul><li><a href=\"../\">ðŸ“‚ Parent Directory</a></li>" >> index.html
          for f in *; do
            if [ "$f" != "index.html" ]; then
              # Add file size if possible, otherwise just name
              size=$(du -h "$f" | cut -f1)
              echo "<li><a href=\"$f\">ðŸ“„ $f</a> <span style=\"color:#666;font-size:0.85em;float:right\">$size</span></li>" >> index.html
            fi
          done
          echo "</ul></body></html>" >> index.html
          cd ../..

          # Generate Landing Page
          cd .. # Go back to root
          python core/gen_site.py --output gh-pages-dist/index.html
          cd gh-pages-dist
          
          # Commit and push
          git config user.name "Monitoring Hub Bot"
          git config user.email "bot@monitoring-hub.local"
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: update yum repository [skip ci]"
            git push origin gh-pages
          fi

