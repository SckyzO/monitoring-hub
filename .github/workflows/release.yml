name: Release and Publish

on:
  push:
    branches: [ main ]
    paths:
      - 'exporters/**'
      - 'core/**'
      - '.github/workflows/**'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # 1. Discover all exporters dynamically
  discover:
    runs-on: ubuntu-latest
    outputs:
      exporters: ${{ steps.set-matrix.outputs.exporters }}
    steps:
      - uses: actions/checkout@v4
      - id: set-matrix
        run: |
          # Find directories in exporters/ containing manifest.yaml
          python3 -c "import os, json; print('exporters=' + json.dumps([d for d in os.listdir('exporters') if os.path.isdir(os.path.join('exporters', d)) and os.path.exists(os.path.join('exporters', d, 'manifest.yaml'))]))" >> $GITHUB_OUTPUT

  # 2. Build Docker Images (Parallel per exporter)
  build-docker:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        exporter: ${{ fromJson(needs.discover.outputs.exporters) }}
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - run: pip install -r core/requirements.txt

      - name: Log in to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push
        run: |
          exporter="${{ matrix.exporter }}"
          echo "Processing $exporter..."
          
          # Check if docker is enabled in manifest
          is_enabled=$(python3 -c "import yaml; m=yaml.safe_load(open('exporters/$exporter/manifest.yaml')); print(m.get('artifacts', {}).get('docker', {}).get('enabled', False))")
          if [ "$is_enabled" != "True" ]; then
            echo "Docker build disabled for $exporter. Skipping."
            exit 0
          fi

          # Generate build files (FORCE amd64 for Docker)
          python core/builder.py --manifest "exporters/$exporter/manifest.yaml" --output-dir "build/$exporter" --arch amd64
          
          version=$(grep "version:" "exporters/$exporter/manifest.yaml" | awk '{print $2}' | tr -d '"')
          
          if [ -f "build/$exporter/Dockerfile" ]; then
             image_id="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/$exporter"
             image_id=$(echo $image_id | tr '[:upper:]' '[:lower:]')
            
             # Currently building amd64 only for Docker as per previous config
             description=$(python3 -c "import yaml; m=yaml.safe_load(open('exporters/$exporter/manifest.yaml')); print(m.get('description', ''))")
             
             docker buildx build \
              --file "build/$exporter/Dockerfile" \
              --push \
              --label "org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}" \
              --label "org.opencontainers.image.description=$description" \
              --tag "$image_id:$version" \
              --tag "$image_id:latest" \
              --platform linux/amd64 \
              "build/$exporter"
          fi

  # 3. Build RPMs (Parallel per exporter, architecture AND distribution)
  build-rpm:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        exporter: ${{ fromJson(needs.discover.outputs.exporters) }}
        arch: [amd64, arm64]
        dist: [el8, el9, el10]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up QEMU
        if: matrix.arch == 'arm64'
        uses: docker/setup-qemu-action@v3

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - run: pip install -r core/requirements.txt

      - name: Build RPM
        run: |
          exporter="${{ matrix.exporter }}"
          arch="${{ matrix.arch }}"
          dist="${{ matrix.dist }}"
          
          # Check if RPM and this dist are requested in the manifest
          is_target=$(python3 -c "import yaml; m=yaml.safe_load(open('exporters/$exporter/manifest.yaml')); print('$dist' in m.get('artifacts', {}).get('rpm', {}).get('targets', []))")
          is_enabled=$(python3 -c "import yaml; m=yaml.safe_load(open('exporters/$exporter/manifest.yaml')); print(m.get('artifacts', {}).get('rpm', {}).get('enabled', False))")
          
          if [ "$is_enabled" != "True" ] || [ "$is_target" != "True" ]; then
            echo "RPM build or distribution $dist not requested for $exporter. Skipping."
            exit 0
          fi

          echo "Building RPM for $exporter ($arch) on $dist..."
          
          # Select correct image for the target distribution
          case $dist in
            el8) image="almalinux:8" ;;
            el9) image="almalinux:9" ;;
            el10) image="quay.io/centos/centos:stream10" ;;
            *) image="almalinux:9" ;;
          esac

          build_dir="build/$exporter-$arch-$dist"
          python core/builder.py --manifest "exporters/$exporter/manifest.yaml" --output-dir "$build_dir" --arch "$arch"
          
          spec_file="$build_dir/$exporter.spec"
          if [ -f "$spec_file" ]; then
            chmod +x core/build_rpm.sh core/utils/rpm_build_entrypoint.sh
            # Pass BOTH architecture and the specific distribution image
            ./core/build_rpm.sh "$spec_file" "$build_dir/rpms" "$arch" "$image"
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rpm-${{ matrix.exporter }}-${{ matrix.arch }}-${{ matrix.dist }}
          path: build/**/rpms/**/*.rpm
          if-no-files-found: ignore

  # 4. Publish YUM Repo & Website (Fan-in)
  publish-yum:
    if: always() && !cancelled() # Run even if some builds failed
    needs: [build-rpm, build-docker]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all_rpms
          pattern: rpm-*
          merge-multiple: true
        continue-on-error: true # Don't crash if NO artifacts found (unlikely but safer)

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - run: pip install -r core/requirements.txt

      - name: Update Repository and Site
        run: |
          git fetch origin gh-pages
          git worktree add -B gh-pages gh-pages-dist origin/gh-pages
          
          cd gh-pages-dist
          
          # Initialize and Update ALL target repositories
          for dist in el8 el9 el10; do
            for arch_name in x86_64 aarch64; do
              mkdir -p "$dist/$arch_name"
              
              # Find and copy matching RPMs
              # We use a broader match for dist (e.g. .el8*) to handle variations like .el8_10
              echo "Moving RPMs for $dist/$arch_name..."
              find ../all_rpms -name "*.$dist*.$arch_name.rpm" -exec cp -v {} "$dist/$arch_name/" \;
              
              # Rebuild Repository Metadata if RPMs exist
              if [ "$(ls -A $dist/$arch_name/*.rpm 2>/dev/null)" ]; then
                echo "Generating YUM metadata for $dist/$arch_name..."
                docker run --rm -v $(pwd):/repo almalinux:9 /bin/bash -c "dnf install -y createrepo_c && \
                   createrepo_c /repo/$dist/$arch_name && \
                   chown -R $(id -u):$(id -g) /repo"
              fi
            done
          done

          # Recursive Index Generation for ALL directories
          find . -type d -not -path '*/.*' | while read dir; do
            echo "Generating index for $dir"
            echo "<!DOCTYPE html><html><head><title>Index of $dir</title><meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"><style>body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif;padding:20px;line-height:1.5}h1{margin-bottom:20px;font-size:1.5em}a{text-decoration:none;color:#0366d6}a:hover{text-decoration:underline}ul{list-style-type:none;padding:0}li{padding:5px 0;border-bottom:1px solid #eee}</style></head><body>" > "$dir/index.html"
            echo "<h1>Index of $dir</h1>" >> "$dir/index.html"
            echo "<ul><li><a href=\"../\">üìÇ Parent Directory</a></li>" >> "$dir/index.html"
            for f in "$dir"/*; do
              fname=$(basename "$f")
              if [ "$fname" != "index.html" ]; then
                 if [ -d "$f" ]; then
                   echo "<li><a href=\"$fname/\">üìÅ $fname/</a></li>" >> "$dir/index.html"
                 else
                   # Note: du -h fails inside the container if file not owned by user, but here we are outside
                   size=$(du -h "$f" | cut -f1)
                   echo "<li><a href=\"$fname\">üìÑ $fname</a> <span style=\"color:#666;font-size:0.85em;float:right\">$size</span></li>" >> "$dir/index.html"
                 fi
              fi
            done
            echo "</ul></body></html>" >> "$dir/index.html"
          done

          # Generate Main Portal with reality check
          cd ..
          python core/gen_site.py --output gh-pages-dist/index.html --repo-dir gh-pages-dist
          cd gh-pages-dist
          
          # Commit and Push
          git config user.name "Monitoring Hub Bot"
          git config user.email "bot@monitoring-hub.local"
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: update all yum repositories and portal [skip ci]"
            git push origin gh-pages
          fi
