name: Release and Publish

on:
  push:
    branches: [ main ]
    paths:
      - 'exporters/**'
      - 'core/**'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push-docker:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -r core/requirements.txt

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Docker Images
        run: |
          for exporter in exporters/*/; do
            if [ -f "${exporter}manifest.yaml" ]; then
              name=$(basename "$exporter")
              echo "Processing $name..."
              
              # Build context setup for multi-arch
              # We stick to amd64 for Docker for this iteration to avoid breaking everything
              # and focus on adding aarch64 RPMs as requested.
              
              # Generate build files (default amd64)
              python core/builder.py --manifest "${exporter}manifest.yaml" --output-dir "build/$name" --arch amd64
              
              # Extract info from manifest for tagging
              version=$(grep "version:" "${exporter}manifest.yaml" | awk '{print $2}' | tr -d '"')
              
              if [ -f "build/$name/Dockerfile" ]; then
                 echo "Building Docker image for $name version $version"
                 
                 image_id="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/$name"
                 image_id=$(echo $image_id | tr '[:upper:]' '[:lower:]')
                
                 docker buildx build \
                  --file "build/$name/Dockerfile" \
                  --push \
                  --label "org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}" \
                  --tag "$image_id:$version" \
                  --tag "$image_id:latest" \
                  --platform linux/amd64 \
                  "build/$name"
              fi
            fi
          done

  update-yum-repo:
    runs-on: ubuntu-latest
    needs: build-and-push-docker
    permissions:
      contents: write # Needed to push to gh-pages
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -r core/requirements.txt

      - name: Generate RPMs (Multi-Arch)
        run: |
          for exporter in exporters/*/; do
            if [ -f "${exporter}manifest.yaml" ]; then
              name=$(basename "$exporter")
              echo "Processing $name for RPM..."
              
              for arch in amd64 arm64; do
                  echo "  -> Building for $arch"
                  build_dir="build/$name-$arch"
                  
                  python core/builder.py --manifest "${exporter}manifest.yaml" --output-dir "$build_dir" --arch "$arch"
                  
                  spec_file="$build_dir/$name.spec"
                  if [ -f "$spec_file" ]; then
                    chmod +x core/build_rpm.sh core/utils/rpm_build_entrypoint.sh
                    # Use distinct output dir for rpms to avoid overwriting
                    ./core/build_rpm.sh "$spec_file" "$build_dir/rpms"
                  fi
              done
            fi
          done

      - name: Update YUM Repository
        run: |
          # Checkout gh-pages
          git fetch origin gh-pages
          git worktree add -B gh-pages gh-pages-dist origin/gh-pages
          
          cd gh-pages-dist
          
          # Prepare directory structure
          # We map:
          # amd64 -> x86_64
          # arm64 -> aarch64
          
          mkdir -p el9/x86_64 el9/aarch64
          
          # Copy new RPMs
          # We need to find where they are in the main worktree
          # amd64
          cp ../build/*-amd64/rpms/*/*.rpm el9/x86_64/ || echo "No new x86_64 RPMs found"
          # arm64
          cp ../build/*-arm64/rpms/*/*.rpm el9/aarch64/ || echo "No new aarch64 RPMs found"
          
          # Update metadata
          docker run --rm -v $(pwd):/repo almalinux:9 /bin/bash -c "dnf install -y createrepo_c && \
             createrepo_c /repo/el9/x86_64 && \
             createrepo_c /repo/el9/aarch64"

          # Generate Recursive Directory Listing (index.html) for all subdirectories
          # This prevents 404s when browsing /el9/ or /el9/x86_64/
          find . -type d -not -path '*/.*' | while read dir; do
            if [ ! -f "$dir/index.html" ]; then
              echo "Generating index for $dir"
              echo "<!DOCTYPE html><html><head><title>Index of $dir</title><meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"><style>body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif;padding:20px;line-height:1.5}h1{margin-bottom:20px;font-size:1.5em}a{text-decoration:none;color:#0366d6}a:hover{text-decoration:underline}ul{list-style-type:none;padding:0}li{padding:5px 0;border-bottom:1px solid #eee}</style></head><body>" > "$dir/index.html"
              echo "<h1>Index of $dir</h1>" >> "$dir/index.html"
              echo "<ul><li><a href=\"../\">üìÇ Parent Directory</a></li>" >> "$dir/index.html"
              
                            # List files and directories
                            for f in "$dir"/*; do
                              fname=$(basename "$f")
                              if [ "$fname" != "index.html" ]; then
                                 if [ -d "$f" ]; then
                                   echo "<li><a href=\"$fname/\">üìÅ $fname/</a></li>" >> "$dir/index.html"
                                 else
                                   size=$(du -h "$f" | cut -f1)
                                   echo "<li><a href=\"$fname\">üìÑ $fname</a> <span style=\"color:#666;font-size:0.85em;float:right\">$size</span></li>" >> "$dir/index.html"
                                 fi
                              fi
                            done
                            echo "</ul></body></html>" >> "$dir/index.html"            fi
          done

          # Generate Landing Page (Main index.html)
          cd .. # Go back to root
          python core/gen_site.py --output gh-pages-dist/index.html
          cd gh-pages-dist
          
          # Commit and push
          git config user.name "Monitoring Hub Bot"
          git config user.email "bot@monitoring-hub.local"
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: update yum repository and landing page [skip ci]"
            git push origin gh-pages
          fi