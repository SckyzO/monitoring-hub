name: ðŸ¤– Auto Release

on:
  push:
    branches: [main]
    paths:
      - 'exporters/*/manifest.yaml'

permissions:
  contents: write
  actions: write

concurrency:
  group: auto-release
  cancel-in-progress: false

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      exporters: ${{ steps.detect.outputs.exporters }}
      matrix: ${{ steps.detect.outputs.matrix }}
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: 'requirements/base.txt'

      - name: ðŸ“¦ Install dependencies
        run: |
          echo "::group::ðŸ“¦ Installing dependencies"
          pip install -r requirements/base.txt
          echo "âœ“ Dependencies installed"
          echo "::endgroup::"

      - name: ðŸ” Detect Changed Exporters
        id: detect
        env:
          PYTHONPATH: ${{ github.workspace }}
          CATALOG_URL: https://sckyzo.github.io/monitoring-hub/catalog.json
        run: |
          echo "::group::ðŸ” Detecting version changes"
          
          # Run state manager to detect changes
          python3 -m core.engine.state_manager > changed_exporters.json
          
          # Read the JSON array
          EXPORTERS=$(cat changed_exporters.json)
          
          echo "Changed exporters: $EXPORTERS"
          
          # Count exporters
          COUNT=$(echo "$EXPORTERS" | jq '. | length')
          echo "Found $COUNT exporter(s) with version changes"
          
          # Set outputs
          echo "exporters=$EXPORTERS" >> $GITHUB_OUTPUT
          echo "matrix={\"exporter\":$EXPORTERS}" >> $GITHUB_OUTPUT
          
          # Display summary
          if [ "$COUNT" -gt 0 ]; then
            echo "âœ“ Will trigger release for: $(echo "$EXPORTERS" | jq -r 'join(", ")')"
          else
            echo "â„¹ï¸  No version changes detected"
          fi
          
          echo "::endgroup::"

      - name: ðŸ“Š Generate Summary
        if: steps.detect.outputs.exporters != '[]'
        run: |
          echo "## ðŸš€ Auto Release Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Detected version changes in the following exporters:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.detect.outputs.exporters }}" | jq -r '.[] | "- **" + . + "**"' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Release workflows will be triggered for each exporter." >> $GITHUB_STEP_SUMMARY

  trigger-releases:
    needs: detect-changes
    if: needs.detect-changes.outputs.exporters != '[]'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    steps:
      - name: ðŸš€ Trigger Release for ${{ matrix.exporter }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::ðŸš€ Triggering release for ${{ matrix.exporter }}"
          
          gh workflow run release.yml \
            --repo ${{ github.repository }} \
            --ref main \
            --field exporter="${{ matrix.exporter }}"
          
          echo "âœ“ Release workflow triggered for ${{ matrix.exporter }}"
          echo "::endgroup::"

      - name: ðŸ“‹ Log Triggered Release
        run: |
          echo "Triggered release workflow for ${{ matrix.exporter }}" >> $GITHUB_STEP_SUMMARY
