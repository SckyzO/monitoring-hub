name: ðŸ¤– Auto Release

on:
  push:
    branches: [main]
    paths:
      - 'exporters/**'

permissions:
  contents: write
  actions: write

concurrency:
  group: auto-release
  cancel-in-progress: false

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      exporters: ${{ steps.detect.outputs.exporters }}
      matrix: ${{ steps.detect.outputs.matrix }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 2  # Need at least 2 commits to diff

      - name: ðŸ” Detect Changed Exporters
        id: detect
        run: |
          echo "::group::ðŸ” Detecting modified exporters"

          # Get changed files in exporters/ directory from the last commit
          # Use git diff to compare with previous commit
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep '^exporters/' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No changes detected in exporters/"
            echo "exporters=[]" >> $GITHUB_OUTPUT
            echo "matrix={\"exporter\":[]}" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 0
          fi

          # Extract unique exporter names from changed paths
          # exporters/node_exporter/manifest.yaml -> node_exporter
          # exporters/blackbox_exporter/assets/config.yml -> blackbox_exporter
          CHANGED_EXPORTERS=$(echo "$CHANGED_FILES" | cut -d'/' -f2 | sort -u)

          # Convert to JSON array
          EXPORTERS_JSON=$(echo "$CHANGED_EXPORTERS" | jq -R -s -c 'split("\n") | map(select(length > 0))')

          echo "Changed exporters: $EXPORTERS_JSON"

          # Count exporters
          COUNT=$(echo "$EXPORTERS_JSON" | jq '. | length')
          echo "Found $COUNT modified exporter(s)"

          # Set outputs
          echo "exporters=$EXPORTERS_JSON" >> $GITHUB_OUTPUT
          echo "matrix={\"exporter\":$EXPORTERS_JSON}" >> $GITHUB_OUTPUT

          # Display summary
          if [ "$COUNT" -gt 0 ]; then
            echo "âœ“ Will trigger release for: $(echo "$EXPORTERS_JSON" | jq -r 'join(", ")')"
          else
            echo "â„¹ï¸  No exporters detected"
          fi

          echo "::endgroup::"

      - name: ðŸ“Š Generate Summary
        if: steps.detect.outputs.exporters != '[]'
        run: |
          echo "## ðŸš€ Auto Release Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Detected file changes in the following exporters:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.detect.outputs.exporters }}" | jq -r '.[] | "- **" + . + "**"' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Release workflows will be triggered to rebuild each modified exporter." >> $GITHUB_STEP_SUMMARY

  trigger-releases:
    needs: detect-changes
    if: needs.detect-changes.outputs.exporters != '[]'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    steps:
      - name: ðŸš€ Trigger Release for ${{ matrix.exporter }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::ðŸš€ Triggering release for ${{ matrix.exporter }}"
          
          gh workflow run release.yml \
            --repo ${{ github.repository }} \
            --ref main \
            --field exporter="${{ matrix.exporter }}"
          
          echo "âœ“ Release workflow triggered for ${{ matrix.exporter }}"
          echo "::endgroup::"

      - name: ðŸ“‹ Log Triggered Release
        run: |
          echo "Triggered release workflow for ${{ matrix.exporter }}" >> $GITHUB_STEP_SUMMARY
