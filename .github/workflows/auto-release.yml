name: ðŸ¤– Auto Release

on:
  push:
    branches: [main]
    paths:
      - 'exporters/**'
  workflow_dispatch:
    inputs:
      exporters:
        description: 'Comma-separated list of exporters to build (leave empty to build ALL exporters)'
        required: false
        type: string
        default: ''

permissions:
  contents: write
  actions: write

concurrency:
  group: auto-release
  cancel-in-progress: false

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      exporters: ${{ steps.detect.outputs.exporters }}
      matrix: ${{ steps.detect.outputs.matrix }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 2  # Need at least 2 commits to diff

      - name: ðŸ” Detect Changed Exporters
        id: detect
        env:
          INPUT_EXPORTERS: ${{ inputs.exporters }}
        run: |
          echo "::group::ðŸ” Detecting modified exporters"

          # Check if workflow was manually triggered
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger detected"
            echo "Input length: ${#INPUT_EXPORTERS}"
            echo "Input value: '$INPUT_EXPORTERS'"

            # Check if specific exporters were provided (non-empty input)
            if [ "${#INPUT_EXPORTERS}" -gt 0 ]; then
              echo "Building specific exporters: $INPUT_EXPORTERS"

              # Convert comma-separated list to JSON array
              EXPORTERS_JSON=$(echo "$INPUT_EXPORTERS" | jq -R -c 'split(",") | map(gsub("^\\s+|\\s+$"; "")) | map(select(length > 0))')

              echo "exporters=$EXPORTERS_JSON" >> $GITHUB_OUTPUT
              echo "matrix={\"exporter\":$EXPORTERS_JSON}" >> $GITHUB_OUTPUT

              COUNT=$(echo "$EXPORTERS_JSON" | jq '. | length')
              echo "âœ“ Building $COUNT specific exporter(s): $(echo "$EXPORTERS_JSON" | jq -r 'join(", ")')"
              echo "::endgroup::"
              exit 0
            else
              # No specific exporters - build ALL
              echo "Building ALL exporters"

              # List all exporters (directories in exporters/)
              ALL_EXPORTERS=$(ls -1 exporters/ | jq -R -s -c 'split("\n") | map(select(length > 0))')

              echo "exporters=$ALL_EXPORTERS" >> $GITHUB_OUTPUT
              echo "matrix={\"exporter\":$ALL_EXPORTERS}" >> $GITHUB_OUTPUT

              COUNT=$(echo "$ALL_EXPORTERS" | jq '. | length')
              echo "âœ“ Building ALL exporters (total: $COUNT)"
              echo "::endgroup::"
              exit 0
            fi
          fi

          # Auto-detect changes from git diff (normal push workflow)
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep '^exporters/' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No changes detected in exporters/"
            echo "exporters=[]" >> $GITHUB_OUTPUT
            echo "matrix={\"exporter\":[]}" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 0
          fi

          # Extract unique exporter names from changed paths
          CHANGED_EXPORTERS=$(echo "$CHANGED_FILES" | cut -d'/' -f2 | sort -u)

          # Convert to JSON array
          EXPORTERS_JSON=$(echo "$CHANGED_EXPORTERS" | jq -R -s -c 'split("\n") | map(select(length > 0))')

          echo "Changed exporters: $EXPORTERS_JSON"

          # Count exporters
          COUNT=$(echo "$EXPORTERS_JSON" | jq '. | length')
          echo "Found $COUNT modified exporter(s)"

          # Set outputs
          echo "exporters=$EXPORTERS_JSON" >> $GITHUB_OUTPUT
          echo "matrix={\"exporter\":$EXPORTERS_JSON}" >> $GITHUB_OUTPUT

          # Display summary
          if [ "$COUNT" -gt 0 ]; then
            echo "âœ“ Will trigger release for: $(echo "$EXPORTERS_JSON" | jq -r 'join(", ")')"
          else
            echo "â„¹ï¸  No exporters detected"
          fi

          echo "::endgroup::"

      - name: ðŸ“Š Generate Summary
        if: steps.detect.outputs.exporters != '[]'
        env:
          EXPORTERS_LIST: ${{ steps.detect.outputs.exporters }}
          TRIGGER_MODE: ${{ github.event_name }}
        run: |
          echo "## ðŸš€ Auto Release Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$TRIGGER_MODE" = "workflow_dispatch" ]; then
            echo "**Mode:** Manual trigger" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Mode:** Automatic (push to main)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Exporters to build:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "$EXPORTERS_LIST" | jq -r '.[] | "- **" + . + "**"' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Release workflows will be triggered for each exporter." >> $GITHUB_STEP_SUMMARY

  trigger-releases:
    name: Release - ${{ matrix.exporter }}
    needs: detect-changes
    if: needs.detect-changes.outputs.exporters != '[]'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    steps:
      - name: ðŸš€ Trigger Release for ${{ matrix.exporter }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::ðŸš€ Triggering release for ${{ matrix.exporter }}"
          
          gh workflow run release.yml \
            --repo ${{ github.repository }} \
            --ref main \
            --field exporter="${{ matrix.exporter }}"
          
          echo "âœ“ Release workflow triggered for ${{ matrix.exporter }}"
          echo "::endgroup::"

      - name: ðŸ“‹ Log Triggered Release
        run: |
          echo "Triggered release workflow for ${{ matrix.exporter }}" >> $GITHUB_STEP_SUMMARY
