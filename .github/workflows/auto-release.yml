name: ü§ñ Auto Release
run-name: >-
  ü§ñ ${{ github.event_name == 'workflow_dispatch'
  && format('Manual Release - {0}', inputs.exporters != '' && inputs.exporters || 'All exporters')
  || 'Automatic Release - New release' }}

on:
  push:
    branches: [main]
    paths:
      - 'exporters/**'
  workflow_dispatch:
    inputs:
      exporters:
        description: 'Comma-separated list of exporters to build (leave empty to build ALL exporters)'
        required: false
        type: string
        default: ''

permissions:
  contents: write
  actions: write

concurrency:
  group: auto-release
  cancel-in-progress: false

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      exporters: ${{ steps.detect.outputs.exporters }}
      matrix: ${{ steps.detect.outputs.matrix }}
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: 'requirements/base.txt'

      - name: Install dependencies
        run: pip install -r requirements/base.txt

      - name: üîç Detect Changed Exporters
        id: detect
        env:
          INPUT_EXPORTERS: ${{ inputs.exporters }}
          CATALOG_URL: https://sckyzo.github.io/monitoring-hub/catalog/index.json
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "::group::üîç Detecting exporters to build"

          # Check if workflow was manually triggered
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger detected"

            # Check if specific exporters were provided
            if [ -n "$INPUT_EXPORTERS" ]; then
              echo "Building specific exporters: $INPUT_EXPORTERS"

              # Convert comma-separated list to JSON array
              EXPORTERS_JSON=$(echo "$INPUT_EXPORTERS" | jq -R -c \
                'split(",") | map(gsub("^\\s+|\\s+$"; "")) | map(select(length > 0))')

              echo "exporters=$EXPORTERS_JSON" >> $GITHUB_OUTPUT
              echo "matrix={\"exporter\":$EXPORTERS_JSON}" >> $GITHUB_OUTPUT

              COUNT=$(echo "$EXPORTERS_JSON" | jq '. | length')
              echo "‚úì Building $COUNT specific exporter(s): $(echo "$EXPORTERS_JSON" | jq -r 'join(", ")')"
              echo "::endgroup::"
              exit 0
            else
              # No specific exporters - force rebuild ALL
              echo "Force rebuild ALL exporters"
              export FORCE_REBUILD=true
            fi
          fi

          # Use state_manager for smart detection
          echo "Using state_manager for change detection..."
          python3 core/engine/state_manager.py

          # Read outputs from state_manager
          EXPORTERS_JSON=$(grep "^exporters=" $GITHUB_OUTPUT | cut -d= -f2)
          BUILD_NEEDED=$(grep "^build_needed=" $GITHUB_OUTPUT | cut -d= -f2)

          if [ "$BUILD_NEEDED" = "false" ]; then
            echo "‚ÑπÔ∏è  No exporters need building (all up to date)"
            echo "matrix={\"exporter\":[]}" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 0
          fi

          # Generate matrix
          echo "matrix={\"exporter\":$EXPORTERS_JSON}" >> $GITHUB_OUTPUT

          COUNT=$(echo "$EXPORTERS_JSON" | jq '. | length')
          echo "‚úì Detected $COUNT exporter(s) to build: $(echo "$EXPORTERS_JSON" | jq -r 'join(", ")')"

          echo "::endgroup::"


      - name: üìä Generate Summary
        if: steps.detect.outputs.exporters != '[]'
        env:
          EXPORTERS_LIST: ${{ steps.detect.outputs.exporters }}
          TRIGGER_MODE: ${{ github.event_name }}
        run: |
          echo "## üöÄ Auto Release Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$TRIGGER_MODE" = "workflow_dispatch" ]; then
            echo "**Mode:** Manual trigger" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Mode:** Automatic (push to main)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Exporters to build:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "$EXPORTERS_LIST" | jq -r '.[] | "- **" + . + "**"' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Release workflows will be triggered for each exporter." >> $GITHUB_STEP_SUMMARY

  trigger-releases:
    name: üéØ Route Build Strategy
    needs: detect-changes
    if: needs.detect-changes.outputs.exporters != '[]'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v6

      - name: üìä Count Exporters
        id: count
        env:
          EXPORTERS: ${{ needs.detect-changes.outputs.exporters }}
        run: |
          count=$(echo "$EXPORTERS" | jq '. | length')
          echo "count=$count" >> $GITHUB_OUTPUT
          echo "Found $count exporter(s) to build"

          # Log exporters list
          echo "$EXPORTERS" | jq -r '.[]' | while read exp; do
            echo "  ‚Üí $exp"
          done

      - name: üöÄ Trigger Single Build
        if: steps.count.outputs.count == '1'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EXPORTERS: ${{ needs.detect-changes.outputs.exporters }}
        run: |
          exporter=$(echo "$EXPORTERS" | jq -r '.[0]')

          echo "::group::üöÄ Triggering single build for $exporter"
          echo "Strategy: Using release.yml (single exporter workflow)"

          # Retry up to 3 times with 10s delay
          max_retries=3
          for i in $(seq 1 $max_retries); do
            if gh workflow run release.yml \
              --repo ${{ github.repository }} \
              --ref main \
              --field exporter="$exporter"; then
              echo "‚úì Release workflow triggered for $exporter"
              echo "## ‚úÖ Single Build Triggered" >> $GITHUB_STEP_SUMMARY
              echo "**Exporter:** $exporter" >> $GITHUB_STEP_SUMMARY
              echo "**Workflow:** release.yml" >> $GITHUB_STEP_SUMMARY
              break
            else
              if [ $i -lt $max_retries ]; then
                echo "‚ö†Ô∏è  Attempt $i failed, retrying in 10s..."
                sleep 10
              else
                echo "‚ùå Failed to trigger workflow after $max_retries attempts"
                exit 1
              fi
            fi
          done

          echo "::endgroup::"

      - name: üèóÔ∏è  Trigger Batch Build
        if: steps.count.outputs.count > '1'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EXPORTERS: ${{ needs.detect-changes.outputs.exporters }}
          COUNT: ${{ steps.count.outputs.count }}
        run: |
          echo "::group::üèóÔ∏è  Triggering batch build for $COUNT exporters"
          echo "Strategy: Using full-build.yml (batch workflow with single publish)"

          # Format exporters list for display
          echo "Exporters:"
          echo "$EXPORTERS" | jq -r '.[]' | while read exp; do
            echo "  ‚Üí $exp"
          done

          # Retry up to 3 times with 10s delay
          max_retries=3
          for i in $(seq 1 $max_retries); do
            if gh workflow run full-build.yml \
              --repo ${{ github.repository }} \
              --ref main \
              --raw-field exporters="$EXPORTERS"; then
              echo "‚úì Full build workflow triggered for $COUNT exporters"

              echo "## ‚úÖ Batch Build Triggered" >> $GITHUB_STEP_SUMMARY
              echo "**Exporters:** $COUNT" >> $GITHUB_STEP_SUMMARY
              echo "**Workflow:** full-build.yml" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**List:**" >> $GITHUB_STEP_SUMMARY
              echo "$EXPORTERS" | jq -r '.[] | "- " + .' >> $GITHUB_STEP_SUMMARY
              break
            else
              if [ $i -lt $max_retries ]; then
                echo "‚ö†Ô∏è  Attempt $i failed, retrying in 10s..."
                sleep 10
              else
                echo "‚ùå Failed to trigger workflow after $max_retries attempts"
                exit 1
              fi
            fi
          done

          echo "::endgroup::"
